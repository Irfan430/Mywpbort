<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IrfanBot Dashboard</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;max-width:980px;margin:32px auto;padding:0 16px}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > div{flex:1 1 280px}
    label{display:block;margin:6px 0 4px;font-weight:600}
    input,select,textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
    button{padding:10px 16px;border:0;border-radius:10px;background:#111827;color:#fff;cursor:pointer}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f3f4f6;margin-right:6px}
    pre{white-space:pre-wrap;background:#0d1117;color:#c9d1d9;border-radius:10px;padding:12px;max-height:300px;overflow:auto}
    small{color:#6b7280}
  </style>
</head>
<body>
  <h1>üõ†Ô∏è IrfanBot Dashboard</h1>
  <div class="card">
    <div class="row">
      <div><label>Origin</label><input id="origin" readonly><small id="copyMsg"></small></div>
      <div><label>Status</label><div id="statusPills"></div></div>
    </div>
    <div class="row">
      <div><label>Admin Key</label><input id="adminKey" placeholder="Set ADMIN_KEY env"></div>
      <div><label>Prefix</label><input id="prefix"></div>
      <div><label>Bot Number</label><input id="botNumber"></div>
    </div>
    <div class="row">
      <div><label>Bot Name</label><input id="botName"></div>
      <div><label>Language</label><input id="language"></div>
      <div><label>Owners (JSON array)</label><input id="owner"></div>
    </div>
    <div class="row">
      <div><label>Mongo Enabled</label>
        <select id="dbEnabled"><option value="false">false</option><option value="true">true</option></select>
      </div>
      <div><label>Session Backup</label>
        <select id="dbBackup"><option value="false">false</option><option value="true">true</option></select>
      </div>
      <div><label>Mongo URI (.env recommended)</label><input id="mongo"></div>
    </div>
    <div class="row">
      <div><button id="saveBtn">Save Config</button></div>
      <div><button id="copyBtn">Copy Origin</button></div>
    </div>
  </div>

  <div class="card">
    <h3>Tail Logs</h3>
    <pre id="logs">Loading...</pre>
  </div>

<script>
async function loadStatus(){
  const res = await fetch('/status');
  const s = await res.json();
  document.getElementById('origin').value = location.origin;
  document.getElementById('prefix').value = s.prefix || '!';
  document.getElementById('botNumber').value = s.botNumber || '';
  document.getElementById('botName').value = s.botName || 'IrfanBot';
  document.getElementById('language').value = s.language || 'en';
  document.getElementById('owner').value = JSON.stringify(s.owner || []);
  document.getElementById('dbEnabled').value = String(!!(s.database && s.database.enabled));
  document.getElementById('dbBackup').value = String(!!(s.database && s.database.sessionBackup));

  const pills = [];
  pills.push(`<span class="pill">${s.connected ? 'üü¢ connected' : 'üî¥ disconnected'}</span>`);
  pills.push(`<span class="pill">node ${s.node}</span>`);
  pills.push(`<span class="pill">${s.app?.name} v${s.app?.version}</span>`);
  document.getElementById('statusPills').innerHTML = pills.join(' ');
}
loadStatus();

async function tail(){
  try{
    const t = await fetch('/logs/tail').then(r=>r.text());
    document.getElementById('logs').textContent = t || 'No logs';
  }catch{}
}
setInterval(tail, 4000); tail();

document.getElementById('copyBtn').onclick = async () => {
  await navigator.clipboard.writeText(location.origin);
  const m = document.getElementById('copyMsg'); m.textContent = 'Copied!';
  setTimeout(()=> m.textContent='', 1200);
};

document.getElementById('saveBtn').onclick = async () => {
  const body = {
    botName: document.getElementById('botName').value.trim(),
    prefix: document.getElementById('prefix').value.trim(),
    botNumber: document.getElementById('botNumber').value.trim(),
    language: document.getElementById('language').value.trim(),
    owner: JSON.parse(document.getElementById('owner').value || '[]'),
    database: {
      enabled: document.getElementById('dbEnabled').value === 'true',
      sessionBackup: document.getElementById('dbBackup').value === 'true',
      mongoURI: document.getElementById('mongo').value.trim()
    }
  };
  const key = document.getElementById('adminKey').value.trim();
  const res = await fetch('/dashboard/save', {
    method:'POST',
    headers:{'Content-Type':'application/json','X-Admin-Key':key},
    body: JSON.stringify(body)
  });
  const j = await res.json().catch(()=>({ok:false,error:'bad json'}));
  alert(j.ok ? 'Saved!' : ('Save failed: ' + j.error));
  loadStatus();
};
</script>
</body>
</html>
