<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>IrfanBot Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .badge { @apply inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium; }
    .badge-green { @apply bg-green-100 text-green-800; }
    .badge-red { @apply bg-red-100 text-red-800; }
    .card { @apply bg-white rounded-2xl shadow p-4; }
    .label { @apply block text-sm font-medium text-gray-700; }
    .input { @apply mt-1 w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500; }
    .switch { @apply h-5 w-10 rounded-full bg-gray-300 relative cursor-pointer; }
    .switch-dot { @apply absolute top-0.5 left-0.5 h-4 w-4 bg-white rounded-full transition; }
    .btn { @apply inline-flex items-center justify-center px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50; }
    .btn-secondary { @apply inline-flex items-center justify-center px-3 py-2 rounded-xl bg-gray-100 text-gray-800 hover:bg-gray-200; }
    .grid-col { @apply grid grid-cols-1 md:grid-cols-2 gap-4; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    textarea::-webkit-scrollbar, pre::-webkit-scrollbar { height: 8px; width: 8px; }
    textarea::-webkit-scrollbar-thumb, pre::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 8px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-4 md:p-8 space-y-6">

    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">IrfanBot Dashboard</h1>
        <p class="text-sm text-gray-600">Live status • Edit config • Tail logs</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="copyOrigin" class="btn-secondary" title="Copy server origin">
          Copy Server URL
        </button>
        <span id="statusBadge" class="badge badge-red">disconnected</span>
      </div>
    </div>

    <!-- Top Info -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card">
        <div class="text-sm text-gray-500">Bot</div>
        <div class="mt-1 font-semibold" id="botName">—</div>
        <div class="mt-1 text-sm"><span class="text-gray-500">Prefix:</span> <span class="mono" id="prefix">—</span></div>
        <div class="mt-1 text-sm"><span class="text-gray-500">Number:</span> <span class="mono" id="botNumber">—</span></div>
      </div>
      <div class="card">
        <div class="text-sm text-gray-500">Owner(s)</div>
        <div class="mt-1 font-medium" id="owner">—</div>
        <div class="mt-1 text-sm"><span class="text-gray-500">Language:</span> <span id="language">—</span></div>
      </div>
      <div class="card">
        <div class="text-sm text-gray-500">Runtime</div>
        <div class="mt-1 text-sm"><span class="text-gray-500">Node:</span> <span class="mono" id="nodeVer">—</span></div>
        <div class="mt-1 text-sm"><span class="text-gray-500">App:</span> <span class="mono" id="appVer">—</span></div>
        <div class="mt-3">
          <button id="refreshBtn" class="btn-secondary">Refresh</button>
        </div>
      </div>
    </div>

    <!-- Config Editor -->
    <div class="card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Configuration</h2>
        <div class="flex items-center gap-2">
          <input id="adminKey" type="password" placeholder="Admin Key (X-Admin-Key)" class="input w-64" />
          <button id="saveBtn" class="btn">Save</button>
        </div>
      </div>

      <div class="grid-col">
        <div class="space-y-3">
          <div>
            <label class="label">Bot Name</label>
            <input id="f_botName" class="input" placeholder="IrfanBot" />
          </div>
          <div>
            <label class="label">Prefix</label>
            <input id="f_prefix" class="input mono" placeholder="!" />
          </div>
          <div>
            <label class="label">Bot Number (with country code)</label>
            <input id="f_botNumber" class="input mono" placeholder="+6598840792" />
          </div>
          <div>
            <label class="label">Language</label>
            <input id="f_language" class="input" placeholder="en" />
          </div>
          <div>
            <label class="label">Owner(s) (comma separated)</label>
            <input id="f_owner" class="input mono" placeholder="+6585062351,+6598840792" />
          </div>
        </div>

        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-2">
            <Toggle id="t_pairingCode" label="Pairing Code" />
            <Toggle id="t_autoRead" label="Auto Read" />
            <Toggle id="t_typingIndicator" label="Typing Indicator" />
            <Toggle id="t_welcome" label="Welcome" />
            <Toggle id="t_goodbye" label="Goodbye" />
            <Toggle id="t_antiCall" label="Anti Call" />
            <Toggle id="t_antiLink" label="Anti Link" />
          </div>

          <div id="antiLinkBlock" class="mt-2 hidden">
            <div>
              <label class="label">AntiLink Action</label>
              <select id="f_antiLink_action" class="input">
                <option value="warn">warn</option>
                <option value="delete">delete</option>
                <option value="kick">kick</option>
              </select>
            </div>
            <div>
              <label class="label">Allowlist (one per line)</label>
              <textarea id="f_antiLink_allowlist" class="input mono" rows="4" placeholder="youtube.com&#10;facebook.com"></textarea>
            </div>
          </div>

          <div class="mt-4 border-t pt-4">
            <div class="flex items-center gap-2">
              <Toggle id="t_db_enabled" label="MongoDB Enabled" />
              <Toggle id="t_db_backup" label="Session Backup" />
            </div>
            <div class="mt-2">
              <label class="label">Mongo URI</label>
              <input id="f_mongoURI" class="input mono" placeholder="mongodb+srv://user:pass@cluster/db" />
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Logs -->
    <div class="card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Logs Tail</h2>
        <div class="flex items-center gap-2">
          <button id="copyLogs" class="btn-secondary">Copy</button>
          <button id="refreshLogs" class="btn-secondary">Refresh</button>
          <label class="text-sm text-gray-600 flex items-center gap-2">
            <input id="autoLogs" type="checkbox" class="rounded" />
            Auto refresh
          </label>
        </div>
      </div>
      <pre id="logs" class="mono bg-slate-900 text-slate-100 rounded-xl p-3 overflow-auto max-h-80">Loading…</pre>
    </div>

    <footer class="text-center text-xs text-gray-500 py-6">
      © <span id="year"></span> IrfanBot • Dashboard running at <span class="mono" id="originTxt"></span>
    </footer>
  </div>

  <!-- tiny Toggle component -->
  <script>
    // render little switches from <Toggle> placeholders
    function ToggleTemplate(id, label) {
      return `
        <div class="flex items-center justify-between gap-3">
          <label for="${id}" class="label m-0">${label}</label>
          <label class="switch">
            <input id="${id}" type="checkbox" class="sr-only" />
            <span class="switch-dot"></span>
          </label>
        </div>
      `;
    }
    document.querySelectorAll('Toggle').forEach(n => {
      const id = n.getAttribute('id');
      const label = n.getAttribute('label') || id;
      n.outerHTML = ToggleTemplate(id, label);
    });
    // move knob
    document.addEventListener('change', (e) => {
      if (e.target.matches('input[type="checkbox"]')) {
        const box = e.target.closest('.switch');
        if (!box) return;
        const dot = box.querySelector('.switch-dot');
        if (e.target.checked) {
          box.classList.remove('bg-gray-300'); box.classList.add('bg-indigo-600');
          dot.style.transform = 'translateX(20px)';
        } else {
          box.classList.add('bg-gray-300'); box.classList.remove('bg-indigo-600');
          dot.style.transform = 'translateX(0px)';
        }
      }
    });
  </script>

  <!-- main logic -->
  <script>
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => document.querySelectorAll(s);

    const el = {
      status: $('#statusBadge'),
      botName: $('#botName'),
      prefix: $('#prefix'),
      botNumber: $('#botNumber'),
      owner: $('#owner'),
      language: $('#language'),
      nodeVer: $('#nodeVer'),
      appVer: $('#appVer'),
      refreshBtn: $('#refreshBtn'),
      copyOrigin: $('#copyOrigin'),
      originTxt: $('#originTxt'),
      year: $('#year'),

      // form
      f_botName: $('#f_botName'),
      f_prefix: $('#f_prefix'),
      f_botNumber: $('#f_botNumber'),
      f_language: $('#f_language'),
      f_owner: $('#f_owner'),
      t_pairingCode: $('#t_pairingCode'),
      t_autoRead: $('#t_autoRead'),
      t_typingIndicator: $('#t_typingIndicator'),
      t_welcome: $('#t_welcome'),
      t_goodbye: $('#t_goodbye'),
      t_antiCall: $('#t_antiCall'),
      t_antiLink: $('#t_antiLink'),
      f_antiLink_action: $('#f_antiLink_action'),
      f_antiLink_allowlist: $('#f_antiLink_allowlist'),
      antiLinkBlock: $('#antiLinkBlock'),

      t_db_enabled: $('#t_db_enabled'),
      t_db_backup: $('#t_db_backup'),
      f_mongoURI: $('#f_mongoURI'),

      adminKey: $('#adminKey'),
      saveBtn: $('#saveBtn'),

      // logs
      logs: $('#logs'),
      copyLogs: $('#copyLogs'),
      refreshLogs: $('#refreshLogs'),
      autoLogs: $('#autoLogs'),
    };

    el.year.textContent = new Date().getFullYear();
    el.originTxt.textContent = window.location.origin;
    el.copyOrigin.onclick = async () => {
      await navigator.clipboard.writeText(window.location.origin);
      toast('Server URL copied');
    };

    let statusTimer = null;
    let logsTimer = null;

    function toast(text, ok = true) {
      const div = document.createElement('div');
      div.textContent = text;
      div.className = `fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded-xl shadow text-white ${ok ? 'bg-green-600' : 'bg-red-600'}`;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 1600);
    }

    function setConn(connected) {
      el.status.textContent = connected ? 'connected' : 'disconnected';
      el.status.className = `badge ${connected ? 'badge-green' : 'badge-red'}`;
    }

    function applySwitchState(input, checked) {
      input.checked = !!checked;
      const evt = new Event('change');
      input.dispatchEvent(evt);
    }

    async function loadStatus() {
      try {
        const r = await fetch('/status');
        const s = await r.json();
        // top cards
        el.botName.textContent = s.botName || '—';
        el.prefix.textContent = s.prefix || '—';
        el.botNumber.textContent = s.botNumber || '—';
        el.owner.textContent = Array.isArray(s.owner) ? s.owner.join(', ') : (s.owner || '—');
        el.language.textContent = s.language || '—';
        el.nodeVer.textContent = s.node || '—';
        el.appVer.textContent = (s.app && s.app.version) ? s.app.version : '—';
        setConn(!!s.connected);

        // form bind
        el.f_botName.value = s.botName || '';
        el.f_prefix.value = s.prefix || '!';
        el.f_botNumber.value = s.botNumber || '';
        el.f_language.value = s.language || 'en';
        el.f_owner.value = Array.isArray(s.owner) ? s.owner.join(',') : (s.owner || '');

        const f = (s.features)||{};
        applySwitchState(el.t_pairingCode, f.pairingCode);
        applySwitchState(el.t_autoRead, f.autoRead);
        applySwitchState(el.t_typingIndicator, f.typingIndicator);
        applySwitchState(el.t_welcome, f.welcome);
        applySwitchState(el.t_goodbye, f.goodbye);
        applySwitchState(el.t_antiCall, f.antiCall);

        // antiLink
        const al = f.antiLink || {};
        applySwitchState(el.t_antiLink, !!al.enabled);
        el.antiLinkBlock.classList.toggle('hidden', !al.enabled);
        el.f_antiLink_action.value = al.action || 'warn';
        el.f_antiLink_allowlist.value = Array.isArray(al.allowlist) ? al.allowlist.join('\n') : '';

        // db
        const db = s.database || {};
        applySwitchState(el.t_db_enabled, !!db.enabled);
        applySwitchState(el.t_db_backup, !!db.sessionBackup);
        el.f_mongoURI.value = db.mongoURI || db.uri || '';

      } catch (e) {
        console.error(e);
        toast('Failed to fetch /status', false);
      }
    }

    async function saveConfig() {
      try {
        const owners = el.f_owner.value
          .split(',')
          .map(s => s.trim())
          .filter(Boolean);

        const allowlist = el.f_antiLink_allowlist.value
          .split('\n')
          .map(s => s.trim())
          .filter(Boolean);

        const body = {
          botName: el.f_botName.value,
          prefix: el.f_prefix.value,
          botNumber: el.f_botNumber.value,
          language: el.f_language.value,
          owner: owners,
          features: {
            pairingCode: el.t_pairingCode.checked,
            autoRead: el.t_autoRead.checked,
            typingIndicator: el.t_typingIndicator.checked,
            welcome: el.t_welcome.checked,
            goodbye: el.t_goodbye.checked,
            antiCall: el.t_antiCall.checked,
            antiLink: el.t_antiLink.checked
          },
          allowlist,
          database: {
            enabled: el.t_db_enabled.checked,
            sessionBackup: el.t_db_backup.checked,
            mongoURI: el.f_mongoURI.value
          }
        };

        const r = await fetch('/dashboard/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': el.adminKey.value || ''
          },
          body: JSON.stringify(body)
        });

        const j = await r.json();
        if (!r.ok || j.ok === false) {
          throw new Error(j.error || 'Save failed');
        }
        toast('Saved ✔');
        // reload status to reflect normalized config
        loadStatus();
      } catch (e) {
        console.error(e);
        toast(String(e.message || e), false);
      }
    }

    async function loadLogs() {
      try {
        const r = await fetch('/logs/tail');
        const t = await r.text();
        el.logs.textContent = t || 'No logs.';
        el.logs.scrollTop = el.logs.scrollHeight;
      } catch {
        el.logs.textContent = 'Failed to load logs.';
      }
    }

    // events
    el.refreshBtn.onclick = loadStatus;
    el.saveBtn.onclick = saveConfig;
    el.refreshLogs.onclick = loadLogs;
    el.copyLogs.onclick = async () => {
      await navigator.clipboard.writeText(el.logs.textContent || '');
      toast('Logs copied');
    };
    el.autoLogs.onchange = () => {
      if (el.autoLogs.checked) {
        logsTimer = setInterval(loadLogs, 3000);
      } else {
        clearInterval(logsTimer);
      }
    };
    el.t_antiLink.onchange = () => {
      el.antiLinkBlock.classList.toggle('hidden', !el.t_antiLink.checked);
    };

    // init
    loadStatus();
    loadLogs();
    statusTimer = setInterval(loadStatus, 5000);
  </script>
</body>
  </html>
