
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>IrfanBot Dashboard</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto;max-width:960px;margin:24px auto;padding:0 16px}
      header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
      .card{border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.05)}
      input,select,button,textarea{padding:8px 12px;border-radius:12px;border:1px solid #d1d5db}
      .row{display:flex;gap:12px;flex-wrap:wrap}.row>*{flex:1}
      pre{background:#0b1021;color:#e5e7eb;padding:12px;border-radius:12px;max-height:200px;overflow:auto}
      .pill{display:inline-block;background:#eef2ff;padding:4px 10px;border-radius:999px;margin-right:6px}
      .muted{color:#6b7280}
    </style>
  </head>
  <body>
    <header>
      <h1>üõ°Ô∏è IrfanBot Dashboard</h1>
      <span class="muted" id="meta"></span>
    </header>

    <div class="card">
      <h2>Status</h2>
      <div id="status">Loading...</div>
      <div id="tags" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h2>Config</h2>
      <div class="row">
        <div><label>Prefix</label><br><input id="prefix"></div>
        <div><label>Language</label><br><select id="language"><option>en</option><option>bn</option></select></div>
      </div>
      <div class="row">
        <div><label>Owners (comma)</label><br><input id="owners"></div>
        <div><label>Bot Number</label><br><input id="botNumber"></div>
      </div>
      <details style="margin-top:8px"><summary>Feature toggles</summary><div id="features" style="margin-top:8px"></div></details>
      <details style="margin-top:8px"><summary>AntiLink allowlist</summary><textarea id="allowlist" rows="3" style="width:100%"></textarea></details>
      <div class="row" style="margin-top:12px">
        <input id="adminKey" placeholder="ADMIN_KEY for save">
        <button id="saveBtn">Save</button>
      </div>
    </div>

    <div class="card">
      <h2>Logs (tail)</h2>
      <pre id="logs">Loading...</pre>
    </div>

    <script>
      async function getJSON(u){const r=await fetch(u);return r.json();}
      function pill(t){const s=document.createElement('span');s.className='pill';s.textContent=t;return s;}
      async function load(){
        const info=await getJSON('/status');
        document.getElementById('status').textContent = info.connected ? 'Connected ‚úÖ' : 'Disconnected ‚õî';
        document.getElementById('meta').textContent = `v${info.app.version} ¬∑ Node ${info.node}`;
        const tags=document.getElementById('tags'); tags.innerHTML='';
        [info.app.name, 'prefix:'+info.config.prefix].forEach(t=>tags.appendChild(pill(t)));

        prefix.value = info.config.prefix;
        language.value = info.config.language;
        owners.value = info.config.owner.join(', ');
        botNumber.value = info.config.botNumber;

        const fwrap = document.getElementById('features'); fwrap.innerHTML='';
        for (const [k,v] of Object.entries(info.config.features)){
          const id='f_'+k, div=document.createElement('div'); div.style.margin='6px 0';
          const chk=document.createElement('input'); chk.type='checkbox'; chk.id=id;
          if (typeof v==='object' && v!==null) chk.checked=!!v.enabled; else chk.checked=!!v;
          const label=document.createElement('label'); label.htmlFor=id; label.textContent=k;
          div.appendChild(chk); div.appendChild(label); fwrap.appendChild(div);
        }
        allowlist.value = (info.config.features.antiLink.allowlist||[]).join('\n');

        const logs = await fetch('/logs/tail').then(r=>r.text());
        document.getElementById('logs').textContent = logs;
      }
      load(); setInterval(load, 5000);

      saveBtn.onclick = async () => {
        const payload = {
          prefix: prefix.value.trim(),
          language: language.value,
          owner: owners.value.split(',').map(s=>s.trim()).filter(Boolean),
          botNumber: botNumber.value.trim(),
          features: {},
          allowlist: allowlist.value.split('\n').map(s=>s.trim()).filter(Boolean)
        };
        document.querySelectorAll('#features input[type=checkbox]').forEach(el => {
          payload.features[el.id.replace('f_','')] = el.checked;
        });
        const adminKey = document.getElementById('adminKey').value.trim();
        const r = await fetch('/dashboard/save', { method:'POST', headers:{'Content-Type':'application/json','X-Admin-Key': adminKey}, body: JSON.stringify(payload) });
        if (r.ok) alert('Saved ‚úÖ'); else alert('Save failed ‚ùå');
      };
    </script>
  </body>
</html>
